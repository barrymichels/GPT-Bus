doctype html
html(lang="en")
    head
        title Bus Rental App
        meta(name="viewport", content="width=device-width, initial-scale=1.0")
        meta(name="theme-color", content="#111827")
        meta(name="description", content="Bus rental management dashboard")
        link(rel="manifest", href="/manifest.json")
        meta(name="apple-mobile-web-app-capable", content="yes")
        meta(name="apple-mobile-web-app-status-bar-style", content="black-translucent")
        meta(name="apple-mobile-web-app-title", content="Bus Rental")
        link(rel="apple-touch-icon", href="/icons/apple-touch-icon.png")
        link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css")
        link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css")
        style.
            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }
    body.bg-gray-800.text-white
        //- Skip to main content link (visible on focus)
        a(href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:bg-blue-600 focus:text-white focus:px-4 focus:py-2 focus:rounded-lg") Skip to main content
        
        header.flex.justify-between.items-center.p-4.bg-gray-900(role="banner")
            a(href="/dashboard" aria-label="Go to dashboard")
                h1.text-xl.font-bold Bus Rental Dashboard
            nav(aria-label="Main navigation")
                div.inline-block.relative
                    button#menu-btn.dropdown-btn(
                        type="button"
                        aria-expanded="false"
                        aria-haspopup="true"
                        aria-controls="menu-dropdown"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                    )
                        i.fas.fa-bars.mr-2(aria-hidden="true")
                        | Menu
                    ul#menu-dropdown.dropdown-menu.absolute.hidden.right-0.mt-1.w-48.rounded-lg.shadow-lg.bg-gray-700.border.border-gray-600.py-1(
                        role="menu"
                        aria-labelledby="menu-btn"
                    )
                        li(role="none")
                            a(href='/trips' role="menuitem" class="block px-4 py-2 text-sm text-white hover:bg-gray-600 transition-colors") Trips
                        li(role="none")
                            a(href='/add-user' role="menuitem" class="block px-4 py-2 text-sm text-white hover:bg-gray-600 transition-colors") Add User
                        li(role="none")
                            a(href='/change-password' role="menuitem" class="block px-4 py-2 text-sm text-white hover:bg-gray-600 transition-colors") Change Password
                        li.border-t.border-gray-600.mt-1.pt-1(role="none")
                            a(href='/logout' role="menuitem" class="block px-4 py-2 text-sm text-white hover:bg-gray-600 transition-colors") Logout
        
        //- Toast notification container
        if flash && flash.message
            #toast-container.fixed.top-4.right-4.z-50
                .toast.flex.items-center.p-4.rounded-lg.shadow-lg.max-w-sm(
                    class=flash.type === 'success' ? 'bg-green-600' : flash.type === 'error' ? 'bg-red-600' : flash.type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
                    role="alert"
                )
                    if flash.type === 'success'
                        i.fas.fa-check-circle.mr-3.text-lg
                    else if flash.type === 'error'
                        i.fas.fa-exclamation-circle.mr-3.text-lg
                    else if flash.type === 'warning'
                        i.fas.fa-exclamation-triangle.mr-3.text-lg
                    else
                        i.fas.fa-info-circle.mr-3.text-lg
                    span.text-white.flex-1= flash.message
                    button(
                        type="button"
                        onclick="this.closest('.toast').remove()"
                        aria-label="Close notification"
                        class="ml-4 text-white hover:text-gray-200 focus:outline-none"
                    )
                        i.fas.fa-times

        main#main-content(role="main")
            block content

    script.
        // Auto-dismiss toast after 4 seconds
        document.addEventListener('DOMContentLoaded', () => {
            const toast = document.querySelector('.toast');
            if (toast) {
                setTimeout(() => {
                    toast.style.transition = 'opacity 0.3s ease-out';
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }
        });

        // Dropdown menu functionality with accessibility
        document.querySelectorAll('.dropdown-btn').forEach(button => {
            const dropdownMenu = button.nextElementSibling;
            const menuItems = dropdownMenu.querySelectorAll('[role="menuitem"]');
            let currentIndex = -1;

            function openMenu() {
                dropdownMenu.classList.remove('hidden');
                button.setAttribute('aria-expanded', 'true');
            }

            function closeMenu() {
                dropdownMenu.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
                currentIndex = -1;
            }

            function focusMenuItem(index) {
                if (index >= 0 && index < menuItems.length) {
                    currentIndex = index;
                    menuItems[index].focus();
                }
            }

            button.addEventListener('click', () => {
                const isExpanded = button.getAttribute('aria-expanded') === 'true';
                if (isExpanded) {
                    closeMenu();
                } else {
                    openMenu();
                    focusMenuItem(0);
                }
            });

            // Keyboard navigation
            button.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openMenu();
                    focusMenuItem(0);
                }
            });

            dropdownMenu.addEventListener('keydown', (e) => {
                switch (e.key) {
                    case 'Escape':
                        closeMenu();
                        button.focus();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        focusMenuItem(currentIndex + 1 < menuItems.length ? currentIndex + 1 : 0);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        focusMenuItem(currentIndex - 1 >= 0 ? currentIndex - 1 : menuItems.length - 1);
                        break;
                    case 'Tab':
                        closeMenu();
                        break;
                }
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!button.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    closeMenu();
                }
            });
        });

        // Phone number formatting
        function formatPhoneNumber(input) {
            // Remove all non-digit characters
            let value = input.value.replace(/\D/g, '');
            
            // Trim to 10 digits if longer
            value = value.substring(0, 10);
            
            // Format with dashes
            if (value.length >= 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{0,4})/, '$1-$2-$3');
            } else if (value.length >= 3) {
                value = value.replace(/(\d{3})(\d{0,3})/, '$1-$2');
            }
            
            input.value = value;
        }

        // Apply formatting to all phone inputs
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[type="tel"]').forEach(input => {
                input.addEventListener('input', (e) => formatPhoneNumber(e.target));
                input.addEventListener('keydown', (e) => {
                    // Allow: backspace, delete, tab, escape, enter
                    if ([46, 8, 9, 27, 13].indexOf(e.keyCode) !== -1 ||
                        // Allow: Ctrl+A, Ctrl+C, Ctrl+V
                        (e.keyCode === 65 && e.ctrlKey === true) ||
                        (e.keyCode === 67 && e.ctrlKey === true) ||
                        (e.keyCode === 86 && e.ctrlKey === true) ||
                        // Allow: home, end, left, right
                        (e.keyCode >= 35 && e.keyCode <= 39)) {
                        return;
                    }
                    // Block non-numeric keys
                    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) &&
                        (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                });
            });

            // Form loading states - prevent double submission and show loading indicator
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn && !submitBtn.disabled) {
                        // Disable button and show loading state
                        submitBtn.disabled = true;
                        submitBtn.dataset.originalText = submitBtn.innerHTML;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                        submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
                    }
                });
            });
        });

    script(src="/js/pwa-register.js")
